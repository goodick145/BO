-- CONFIG
getgenv().G = true
getgenv().Creator = " - HalloweenGaster"

-- SERVICES & VARIABLES
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer
local remote = ReplicatedStorage:WaitForChild("RemoteEvents"):WaitForChild("BladeCombatRemote")
local character = player.Character or player.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")

-- ANTI-AFK
pcall(function()
    local vu = game:GetService("VirtualUser")
    player.Idled:Connect(function()
        vu:Button2Down(Vector2.new(0, 0), workspace.CurrentCamera.CFrame)
        task.wait(1)
        vu:Button2Up(Vector2.new(0, 0), workspace.CurrentCamera.CFrame)
    end)
end)

-- BOSS NAMES
local bossNames = { "Zoro (TS)", "Zoro (PTS)" }

local active = true
local hovering = false
local lastBossPosition = nil
local maxDistance = 100

-- UI
local gui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
gui.ResetOnSpawn = false

local toggleBtn = Instance.new("TextButton")
toggleBtn.Size = UDim2.new(0, 120, 0, 40)
toggleBtn.Position = UDim2.new(0, 20, 0, 100)
toggleBtn.Text = "Hover: ON"
toggleBtn.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
toggleBtn.TextColor3 = Color3.new(1, 1, 1)
toggleBtn.Parent = gui

local hpLabel = Instance.new("TextLabel")
hpLabel.Size = UDim2.new(0, 220, 0, 30)
hpLabel.Position = UDim2.new(0, 20, 0, 150)
hpLabel.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
hpLabel.TextColor3 = Color3.new(1, 1, 1)
hpLabel.TextScaled = true
hpLabel.Text = "Boss HP: N/A"
hpLabel.Parent = gui

-- UTILITIES
local function getHRP()
    character = player.Character or player.CharacterAdded:Wait()
    return character:WaitForChild("HumanoidRootPart")
end

local function isAlive(model)
    local hum = model and model:FindFirstChildOfClass("Humanoid")
    return hum and hum.Health > 0
end

local function getBoss()
    local bossesFolder = workspace:FindFirstChild("Live") and workspace.Live:FindFirstChild("Bosses")
    if bossesFolder then
        for _, name in ipairs(bossNames) do
            local boss = bossesFolder:FindFirstChild(name)
            if boss and isAlive(boss) and boss:FindFirstChild("HumanoidRootPart") then
                lastBossPosition = boss.HumanoidRootPart.Position
                return boss
            end
        end
    end
    return nil
end

-- Spam skill
local function spamSkill()
    local sorcerer = player.Character and player.Character:FindFirstChild("Sorcerer Killer")
    if sorcerer and sorcerer:FindFirstChild("Functions") then
        local args = { "Chain Of A Thousand Miles" }
        sorcerer.Functions:FireServer(unpack(args))
    end
end

-- Attack loop – giảm tốc độ spam xuống 1 giây
task.spawn(function()
    while true do
        if active then
            sethiddenproperty(player, "SimulationRadius", math.huge)
            sethiddenproperty(player, "MaxSimulationRadius", math.huge)

            local hrp = getHRP()
            local boss = getBoss()
            if boss then
                local bossHRP = boss.HumanoidRootPart
                local hum = boss:FindFirstChildOfClass("Humanoid")
                if (hrp.Position - bossHRP.Position).Magnitude <= maxDistance then
                    pcall(function()
                        remote:FireServer(true, bossHRP.Position, bossHRP.CFrame)
                    end)
                    spamSkill()
                end
                if hum then
                    hpLabel.Text = string.format("Boss HP: %s - %.0f", boss.Name, hum.Health)
                end
            else
                hpLabel.Text = "Boss HP: N/A"
            end
        end
        task.wait(2) -- giảm tốc độ
    end
end)

-- Hover loop – chống rơi xuống void bằng cách giữ Anchored
local function hoverLoop()
    if hovering then return end
    hovering = true
    while active do
        local hrp = getHRP()
        local boss = getBoss()
        if boss and isAlive(boss) then
            -- Bật lại trọng lực bình thường để di chuyển theo boss
            local hum = character:FindFirstChildOfClass("Humanoid")
            if hum then hum.PlatformStand = false end
            hrp.Anchored = false

            local bossHRP = boss.HumanoidRootPart
            local targetPos = bossHRP.Position + Vector3.new(0, 5, 0)
            if (hrp.Position - targetPos).Magnitude > 3 then
                hrp.CFrame = CFrame.new(targetPos)
            end
        else
            -- Khi không có boss, bật chế độ "mất trọng lực" để không rơi
            local hum = character:FindFirstChildOfClass("Humanoid")
            if hum then hum.PlatformStand = true end
            hrp.Anchored = true
            if lastBossPosition then
                hrp.CFrame = CFrame.new(lastBossPosition + Vector3.new(0, 10, 0))
            else
                -- nếu chưa từng gặp boss, giữ nguyên vị trí hiện tại
                hrp.CFrame = CFrame.new(hrp.Position + Vector3.new(0, 10, 0))
            end
        end
        task.wait(0.6)
    end
    hovering = false
end

player.CharacterAdded:Connect(function(char)
    character = char
    hrp = character:WaitForChild("HumanoidRootPart")
    if active then
        task.delay(1, function()
            if active then hoverLoop() end
        end)
    end
end)

toggleBtn.MouseButton1Click:Connect(function()
    active = not active
    if active then
        toggleBtn.Text = "Hovering..."
        toggleBtn.BackgroundColor3 = Color3.fromRGB(255, 170, 0)
        task.spawn(hoverLoop)
        task.wait(0.5)
        toggleBtn.Text = "Hover: ON"
        toggleBtn.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
    else
        toggleBtn.Text = "Hover: OFF"
        toggleBtn.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
        -- tắt chống rơi nếu ngừng
        pcall(function()
            hrp.Anchored = false
            local hum = character:FindFirstChildOfClass("Humanoid")
            if hum then hum.PlatformStand = false end
        end)
    end
end)

task.spawn(hoverLoop)
